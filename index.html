<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dungeon Portal - Free Tier</title>
    <link rel="icon" href="dd.png">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #121212;
            --bg-panel: #1e1e24;
            --accent: #d4af37;
            --text-main: #e0e0e0;
            --danger: #cf6679;
            --magic: #bd93f9;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
            margin: 0; padding: 0;
            height: 100vh; width: 100vw;
            display: grid;
            grid-template-columns: 420px 1fr 300px;
            grid-template-rows: 60px 1fr;
            overflow: hidden;
            user-select: none;
        }

        /* --- MODALES (LOGIN Y CONFIG) --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 2000;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
        }
        .modal-box {
            background: var(--bg-panel); border: 2px solid var(--accent);
            padding: 30px; text-align: center; border-radius: 10px;
            box-shadow: 0 0 40px rgba(212, 175, 55, 0.2);
            max-width: 500px; width: 90%; position: relative;
        }
        .modal-close { position: absolute; top: 10px; right: 15px; cursor: pointer; color: #fff; font-size: 1.2rem; }
        
        input.clean-input { 
            width: 100%; font-size: 1.1rem; padding: 12px; margin: 15px 0; 
            text-align: center; background: #333; color: white; border: 1px solid #555;
            border-radius: 5px; outline: none;
        }
        input.clean-input:focus { border-color: var(--accent); }

        /* --- UI GENERAL --- */
        header {
            grid-column: 1 / -1; background: #000; border-bottom: 2px solid var(--accent);
            display: flex; align-items: center; padding: 0 20px; justify-content: space-between; z-index: 10;
        }
        h1 { font-family: 'Cinzel', serif; color: var(--accent); margin: 0; font-size: 1.5rem; display: flex; align-items: center; gap: 10px; }

        .panel { 
            background: var(--bg-panel); padding: 15px; overflow-y: auto; 
            border-right: 1px solid #333; z-index: 5; height: 100%; box-sizing: border-box;
        }
        .panel-right { border-left: 1px solid #333; border-right: none; }
        
        button {
            background: #333; color: var(--text-main); border: 1px solid #555;
            padding: 8px 12px; cursor: pointer; border-radius: 4px; transition: 0.2s; margin-bottom: 5px;
        }
        button:hover { background: #444; border-color: var(--text-main); }
        button.primary { background: var(--accent); color: #000; font-weight: bold; border: none; }
        button.danger { background: var(--danger); color: #fff; border: none; }
        button.magic { background: var(--magic); color: #000; font-weight: bold; border: none; }
        button.settings { background: #000; border: 1px solid var(--accent); color: var(--accent); }

        /* --- CHAT Y MAPA --- */
        .main-area {
            grid-column: 2; grid-row: 2; display: flex; flex-direction: column; 
            background: #000; position: relative; height: 100%; overflow: hidden;
        }
        #map-container {
            flex: 1; position: relative; background: #111;
            display: flex; align-items: center; justify-content: center; overflow: hidden;
        }
        #map-img { width: 100%; height: 100%; object-fit: contain; pointer-events: none; }

        #chat-container {
            flex: 0 0 300px; border-top: 2px solid var(--accent); 
            background: rgba(0,0,0,0.95); display: flex; flex-direction: column; z-index: 10;
        }
        #chat-box { flex-grow: 1; overflow-y: auto; padding: 15px; font-size: 0.95rem; }
        .chat-input-area { display: flex; padding: 10px; gap: 5px; background: #1e1e24; }
        .chat-input-area input { flex-grow: 1; background: #333; border: 1px solid #555; color: white; padding: 10px; border-radius: 4px; }

        /* --- TOKENS Y GRID --- */
        .layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        #grid-layer {
            background-image: linear-gradient(#555 1px, transparent 1px), linear-gradient(90deg, #555 1px, transparent 1px);
            background-size: 50px 50px; opacity: 0.3; display: none;
        }
        #grid-layer.visible { display: block; }

        .token {
            width: 45px; height: 45px; border-radius: 50%; position: absolute;
            transform: translate(-50%, -50%); pointer-events: auto; cursor: grab;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-family: 'Cinzel', serif; color: white;
            text-shadow: 0 0 4px black; box-shadow: 0 0 10px rgba(0,0,0,0.8);
            border: 2px solid white; z-index: 100;
        }
        .token-name {
            position: absolute; top: -20px; background: rgba(0,0,0,0.7); 
            padding: 2px 5px; border-radius: 4px; font-size: 0.7rem; white-space: nowrap; pointer-events: none;
        }

        /* --- TARJETAS PJ --- */
        .char-card {
            background: #2a2a2e; border: 1px solid #444; padding: 10px; margin-bottom: 15px;
            border-radius: 6px; box-shadow: 0 2px 5px rgba(0,0,0,0.3); border-left: 5px solid transparent;
        }
        .msg.ai { border-left: 3px solid var(--magic); padding-left: 10px; color: #e0d0ff; background: rgba(189, 147, 249, 0.05); margin-bottom: 8px;}
        .msg strong { color: var(--accent); }

        /* --- RESPONSIVE --- */
        @media (max-width: 800px) {
            body { grid-template-columns: 1fr; grid-template-rows: 60px auto 1fr auto; overflow-y: scroll; }
            .panel { max-height: 300px; }
            .main-area { grid-column: 1; height: 50vh; }
            #chat-container { flex: 0 0 200px; }
        }
    </style>
</head>
<body>

    <div id="login-modal" class="modal-overlay">
        <div class="modal-box">
            <h1><img src="dd.png" width="100px"></h1>
            <h2>Dungeon Portal</h2>
            <input type="text" id="login-name" class="clean-input" placeholder="Tu Nombre de Jugador" autocomplete="off">
            <button class="primary" onclick="login()" style="width:100%; padding: 15px;">ENTRAR</button>
        </div>
    </div>

    <div id="settings-modal" class="modal-overlay" style="display:none;">
        <div class="modal-box">
            <span class="modal-close" onclick="closeSettings()">‚úï</span>
            <h2 style="color: var(--magic);">üîë Llave Maestra (Google AI)</h2>
            <p style="font-size: 0.9rem; color: #ccc;">
                Para usar la IA, pega tu <strong>Google API Key</strong> aqu√≠.<br>
                Se guardar√° solo en tu navegador (Seguro y Privado).
            </p>
            <input type="password" id="api-key-input" class="clean-input" placeholder="Pega tu API Key (AIzaSy...)" autocomplete="off">
            <button class="magic" onclick="saveApiKey()" style="width:100%; padding: 10px;">üíæ Guardar y Conectar</button>
            <p style="font-size: 0.8rem; margin-top: 15px; color: #888;">
                <a href="https://aistudio.google.com/app/apikey" target="_blank" style="color: var(--accent);">¬øNo tienes Key? Cons√≠guela Gratis Aqu√≠</a>
            </p>
        </div>
    </div>

    <header>
        <h1><img src="dd.png" width="80px"> Dungeon Portal</h1>
        <div style="display: flex; gap: 10px; align-items: center;">
            <button class="settings" onclick="openSettings()">‚öôÔ∏è API Key</button>
            <span id="player-display" style="color: var(--accent); font-size: 0.9rem;">...</span>
            <button onclick="logout()" style="font-size:0.7rem;">Salir</button>
        </div>
    </header>

    <div class="panel">
        <h3 style="color: #1DB954;">üéµ M√∫sica</h3>
        <div style="text-align: center; background: #000; padding: 10px; border-radius: 5px;">
            <audio id="audio-player" controls loop style="width:100%; margin-bottom:5px;"></audio>
            <div style="display:flex; gap:5px;">
                <button onclick="playMusic('batalla.mp3')" style="flex:1;">‚öîÔ∏è</button>
                <button onclick="playMusic('taberna.mp3')" style="flex:1;">üç∫</button>
                <button onclick="playMusic('bosque.mp3')" style="flex:1;">üå≤</button>
                <button onclick="stopMusic()" class="danger" style="flex:1;">‚èπÔ∏è</button>
            </div>
        </div>

        <hr style="border-color: #333; margin: 20px 0;">

        <h3>üõ°Ô∏è DM Tools</h3>
        <input type="text" id="map-url" placeholder="URL Mapa Manual" class="clean-input" style="padding: 5px; margin: 5px 0;">
        <button onclick="updateMap()" style="width:100%">Cargar Mapa</button>
        <button onclick="toggleGrid()" style="width:100%">Cuadr√≠cula</button>
        <button class="danger" onclick="resetChat()" style="width:100%; margin-top:10px;">Borrar Chat</button>
        <button class="danger" onclick="resetCharacters()" style="width:100%">Borrar PJs</button>

        <hr style="border-color: #333; margin: 20px 0;">

        <h3>üßô Crear PJ</h3>
        <input type="text" id="new-name" placeholder="Nombre" class="clean-input" style="padding: 5px; margin: 5px 0;">
        <select id="new-race" class="clean-input" style="padding: 5px; margin: 5px 0; text-align: left;">
            <option>Humano</option><option>Elfo</option><option>Enano</option><option>Mago</option>
        </select>
        <button class="primary" onclick="createCharacter()" style="width:100%">Invocar</button>
    </div>

    <div class="main-area">
        <div id="map-container">
            <img id="map-img" src="fondo.png">
            <div id="grid-layer" class="layer"></div>
            <div id="token-layer" class="layer"></div>
        </div>
        <div id="chat-container">
            <div id="chat-box"></div>
            <div class="chat-input-area">
                <input type="text" id="chat-input" placeholder="Escribe aqu√≠... (Usa el bot√≥n IA para narrar)">
                <button class="primary" onclick="sendMessage()">Enviar</button>
                <button onclick="askGoogleAI()" class="magic">‚ú® IA</button>
            </div>
        </div>
    </div>

    <div class="panel panel-right">
        <div style="text-align: center; margin-bottom: 20px;">
            <button onclick="rollDice(20)" class="primary" style="font-size: 1.2rem; padding: 10px; width: 100%;">üé≤ D20</button>
        </div>
        <h3 style="border-bottom: 1px solid #444;">Personajes</h3>
        <div id="char-list"></div>
    </div>

    <script type="module">
        // --- FIREBASE CONFIG ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getFirestore, doc, onSnapshot, updateDoc, setDoc, arrayUnion, getDoc } 
        from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBx_002WWXTyiKT_rrlyaAW0JtHoIiSpTE", // Esta es de Firebase (p√∫blica), no tocar.
            authDomain: "dungeon-party-ai.firebaseapp.com",
            projectId: "dungeon-party-ai",
            storageBucket: "dungeon-party-ai.firebasestorage.app",
            messagingSenderId: "409663650732",
            appId: "1:409663650732:web:4bf6681e14874039ffd809"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const gameRef = doc(db, "games", "partida_main");

        let gameState = { chat: [], characters: [], mapUrl: "", musicUrl: "" };
        let localPlayer = sessionStorage.getItem("dnd_player") || null;

        // --- GESTI√ìN DE JUGADOR Y API KEY ---
        window.checkLogin = () => {
            if (localPlayer) {
                document.getElementById('login-modal').style.display = 'none';
                document.getElementById('player-display').innerText = localPlayer;
            } else {
                document.getElementById('login-modal').style.display = 'flex';
            }
        };
        window.login = () => {
            const n = document.getElementById('login-name').value.trim();
            if(n) { localPlayer = n; sessionStorage.setItem("dnd_player", n); window.checkLogin(); }
        };
        window.logout = () => { sessionStorage.removeItem("dnd_player"); location.reload(); };

        window.openSettings = () => {
            document.getElementById('settings-modal').style.display = 'flex';
            document.getElementById('api-key-input').value = localStorage.getItem('google_ai_key') || "";
        };
        window.closeSettings = () => { document.getElementById('settings-modal').style.display = 'none'; };
        window.saveApiKey = () => {
            const key = document.getElementById('api-key-input').value.trim();
            if(key) {
                localStorage.setItem('google_ai_key', key);
                alert("‚úÖ Clave guardada correctamente.");
                window.closeSettings();
            } else {
                alert("‚ö†Ô∏è La clave no puede estar vac√≠a.");
            }
        };

        // --- L√ìGICA DEL JUEGO (FIREBASE) ---
        async function initGame() {
            const docSnap = await getDoc(gameRef);
            if (!docSnap.exists()) await setDoc(gameRef, { chat: [], characters: [], mapUrl: "fondo.png", musicUrl: "" });
            onSnapshot(gameRef, (doc) => {
                if(doc.exists()) {
                    gameState = doc.data();
                    renderChat(); renderCharacters(); renderMap(); checkMusic();
                }
            });
        }

        // --- RENDERIZADO ---
        function renderChat() {
            const box = document.getElementById('chat-box');
            box.innerHTML = gameState.chat.map(m => 
                `<div class="msg ${m.type || ''}"><strong>${m.user}:</strong> ${m.text}</div>`
            ).join('');
            box.scrollTop = box.scrollHeight;
        }

        function renderCharacters() {
            document.getElementById('char-list').innerHTML = gameState.characters.map(c => `
                <div class="char-card" style="border-left-color:${c.color}">
                    <div style="display:flex; justify-content:space-between;">
                        <strong>${c.name}</strong> <small>${c.race}</small>
                        <button class="danger" onclick="deleteChar('${c.id}')" style="padding:0 5px;">√ó</button>
                    </div>
                    <div style="background:#444; height:10px; margin:5px 0; border-radius:5px;">
                        <div style="width:${(c.hp/c.maxHp)*100}%; background:${c.color}; height:100%; border-radius:5px;"></div>
                    </div>
                    <div style="font-size:0.8rem; text-align:center;">HP: ${c.hp} / ${c.maxHp}</div>
                    <div style="display:flex; gap:5px; margin-top:5px;">
                        <button onclick="modHp('${c.id}', -1)" style="flex:1;">-</button>
                        <button onclick="modHp('${c.id}', 1)" style="flex:1;">+</button>
                    </div>
                </div>
            `).join('');
        }

        let isDrag = false, dragId = null;
        function renderMap() {
            if(isDrag) return;
            const img = document.getElementById('map-img');
            if(!img.src.includes(gameState.mapUrl || 'fondo.png')) img.src = gameState.mapUrl || 'fondo.png';
            
            const layer = document.getElementById('token-layer');
            layer.innerHTML = "";
            gameState.characters.forEach(c => {
                const t = document.createElement('div');
                t.className = 'token'; t.style.left = c.x + '%'; t.style.top = c.y + '%';
                t.style.borderColor = c.color; t.style.background = c.color; t.innerText = c.name.substring(0,2).toUpperCase();
                t.innerHTML += `<div class="token-name">${c.name}</div>`;
                t.onmousedown = (e) => { isDrag = true; dragId = c.id; e.preventDefault(); };
                layer.appendChild(t);
            });
        }

        // --- INPUTS Y EVENTOS ---
        const mapCont = document.getElementById('map-container');
        window.addEventListener('mousemove', (e) => {
            if(!isDrag) return;
            const r = mapCont.getBoundingClientRect();
            let x = ((e.clientX - r.left)/r.width)*100, y = ((e.clientY - r.top)/r.height)*100;
            // Limitar a 0-100%
            x = Math.max(0, Math.min(100, x)); y = Math.max(0, Math.min(100, y));
            // Actualizar visualmente (sin guardar a√∫n para rendimiento)
            // (Simplificado: en este c√≥digo actualizamos visualmente al soltar o podr√≠amos mover el elemento DOM directament)
        });
        window.addEventListener('mouseup', async (e) => {
            if(!isDrag) return;
            const r = mapCont.getBoundingClientRect();
            let x = ((e.clientX - r.left)/r.width)*100, y = ((e.clientY - r.top)/r.height)*100;
            x = Math.max(0, Math.min(100, x)); y = Math.max(0, Math.min(100, y));
            
            const newChars = gameState.characters.map(c => {
                if(c.id === dragId) { c.x = x; c.y = y; } return c;
            });
            isDrag = false; dragId = null;
            await updateDoc(gameRef, { characters: newChars });
        });

        // --- ACCIONES DM ---
        window.createCharacter = async () => {
            const name = document.getElementById('new-name').value;
            const race = document.getElementById('new-race').value;
            if(!name) return;
            const newChar = {
                id: Date.now().toString(), name, race, hp: 20, maxHp: 20,
                x: 50, y: 50, color: `hsl(${Math.random()*360}, 70%, 50%)`
            };
            await updateDoc(gameRef, { characters: arrayUnion(newChar) });
            document.getElementById('new-name').value = "";
        };
        window.deleteChar = async(id) => {
            const list = gameState.characters.filter(c => c.id !== id);
            await updateDoc(gameRef, { characters: list });
        };
        window.modHp = async(id, v) => {
            const list = gameState.characters.map(c => {
                if(c.id === id) c.hp += v; return c;
            });
            await updateDoc(gameRef, { characters: list });
        };
        window.updateMap = async() => {
            const url = document.getElementById('map-url').value;
            if(url) await updateDoc(gameRef, { mapUrl: url });
        };
        window.toggleGrid = () => document.getElementById('grid-layer').classList.toggle('visible');
        window.resetChat = async() => await updateDoc(gameRef, { chat: [] });
        window.resetCharacters = async() => await updateDoc(gameRef, { characters: [] });
        window.sendMessage = async() => {
            const t = document.getElementById('chat-input').value;
            if(t) {
                await updateDoc(gameRef, { chat: arrayUnion({ user: localPlayer, text: t }) });
                document.getElementById('chat-input').value = "";
            }
        };
        window.rollDice = async(s) => {
            const r = Math.floor(Math.random()*s)+1;
            await updateDoc(gameRef, { chat: arrayUnion({ user: "Sistema", text: `${localPlayer} tir√≥ 1d${s} ‚ûî ${r}`, type: "system" }) });
        };
        
        // --- AUDIO ---
        let lastMusic = "";
        function checkMusic() {
            if(gameState.musicUrl !== lastMusic) {
                lastMusic = gameState.musicUrl;
                const a = document.getElementById('audio-player');
                if(lastMusic) { a.src = lastMusic; a.play().catch(e=>console.log("Autoplay blocked")); }
                else { a.pause(); }
            }
        }
        window.playMusic = async(u) => await updateDoc(gameRef, { musicUrl: u });
        window.stopMusic = async() => await updateDoc(gameRef, { musicUrl: "" });

        // ======================================================
        // üß† CEREBRO DE IA - EXCLUSIVO GOOGLE FREE TIER (v1beta)
        // ======================================================
        window.askGoogleAI = async () => {
            const key = localStorage.getItem('google_ai_key');
            if(!key) {
                alert("‚ö†Ô∏è FALTA API KEY. Ve a Configuraci√≥n y p√©gala.");
                window.openSettings();
                return;
            }

            const input = document.getElementById('chat-input');
            const query = input.value;
            if(!query) return alert("Escribe algo en el chat primero.");
            
            input.value = "üîÆ Invocando a Gemini...";

            // PROMPT ESTRICTO
            const prompt = `
            Act√∫a como un Dungeon Master de D&D. 
            Entrada del Jugador: "${query}"
            
            IMPORTANTE: Responde SOLO con este formato exacto usando separadores |||:
            HISTORIA: [Narraci√≥n en espa√±ol, inmersiva pero breve] ||| MAPA: [Descripci√≥n visual en ingl√©s del entorno para generar una imagen top-down battlemap, o NULL si el lugar no cambia] ||| ENEMIGOS: [Lista de nombres de enemigos en espa√±ol separados por comas, o NULL si no aparecen nuevos]
            `;

            try {
                // MODELO: gemini-1.5-flash (El mejor para Free Tier actualmente)
                // VERSION: v1beta (Necesaria para Flash)
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${key}`;
                
                const response = await fetch(url, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                if(!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData.error?.message || "Error desconocido de API");
                }

                const data = await response.json();
                const textResponse = data.candidates[0].content.parts[0].text;

                // PROCESAMIENTO
                const parts = textResponse.split('|||');
                const historia = parts[0]?.replace(/HISTORIA:/i, '').trim();
                const mapaPrompt = parts[1]?.replace(/MAPA:/i, '').trim();
                const enemigos = parts[2]?.replace(/ENEMIGOS:/i, '').trim();

                // 1. Enviar historia
                if(historia) await updateDoc(gameRef, { chat: arrayUnion({ user: "DM IA", text: historia, type: "ai" }) });

                // 2. Generar Mapa (Si aplica)
                if(mapaPrompt && !mapaPrompt.toUpperCase().includes("NULL") && mapaPrompt.length > 5) {
                    const seed = Math.floor(Math.random() * 10000);
                    // Usamos Pollinations SOLO para la imagen (esto siempre es gratis y estable)
                    const mapUrl = `https://image.pollinations.ai/prompt/dnd battle map top down rpg gridless ${mapaPrompt} ${seed}?width=1080&height=720&nologo=true`;
                    await updateDoc(gameRef, { mapUrl: mapUrl });
                    await updateDoc(gameRef, { chat: arrayUnion({ user: "Sistema", text: "üåç El escenario ha cambiado...", type: "system" }) });
                }

                // 3. Invocar Enemigos (Si aplica)
                if(enemigos && !enemigos.toUpperCase().includes("NULL") && enemigos.length > 2) {
                    const lista = enemigos.split(',');
                    for(let e of lista) {
                        let nombreLimpio = e.trim().replace(/[".]/g, '');
                        if(nombreLimpio) {
                            const newEnemy = {
                                id: Date.now() + Math.random().toString(), 
                                name: nombreLimpio, race: "Enemigo", hp: 15, maxHp: 15,
                                x: 50 + (Math.random()*10-5), y: 50 + (Math.random()*10-5), 
                                color: "#cf6679"
                            };
                            await updateDoc(gameRef, { characters: arrayUnion(newEnemy) });
                        }
                    }
                    await updateDoc(gameRef, { chat: arrayUnion({ user: "Sistema", text: `‚ö†Ô∏è Enemigos detectados: ${enemigos}`, type: "system" }) });
                }

                input.value = ""; // Limpiar input si todo sali√≥ bien

            } catch (error) {
                console.error(error);
                alert("Error de IA: " + error.message);
                input.value = query; // Devolver el texto para que no se pierda
            }
        };

        // Inicializar
        checkLogin();
        initGame();

    </script>
</body>
</html>
